## CSS –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebResourceManager –≤ —Å–µ—Ä–≤–ª–µ—Ç–µ

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mail Items Dashboard</title>
	## –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ CSS —á–µ—Ä–µ–∑ –Ω–∞—à servlet
	<link rel="stylesheet" type="text/css" href="css/mail-table.css">
</head>
<body>
<div class="container">
	<div class="header">
		<h1>üìß Mail Items Dashboard</h1>
		<p>Manage and view your mail items with style</p>
	</div>
	<div class="actions">
		<button id="create-test-data-btn" class="create-btn">
			üìù Create Test Data
		</button>
		<button id="delete-all-btn" class="delete-btn">
			üóëÔ∏è Delete All Items
		</button>
	</div>
	<div id="loading" class="loading">
		<div class="spinner"></div>
		<p>Loading mail items...</p>
	</div>

	<div id="content" style="display: none;">
		<div class="table-container">
			<table class="mail-table">
				<thead>
				<tr>
					<th>ID</th>
					<th>From</th>
					<th>To</th>
					<th>Subject</th>
					<th>Body</th>
				</tr>
				</thead>
				<tbody id="mail-items-body">
				<!-- Data will be inserted here -->
				</tbody>
			</table>
		</div>
		<div id="stats" class="stats">
			<!-- Stats will be shown here -->
		</div>
	</div>

	<div id="empty-state" class="empty-state" style="display: none;">
		<svg class="empty-icon" fill="currentColor" viewBox="0 0 20 20">
			<path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
			<path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
		</svg>
		<h3>No mail items found</h3>
		<p>There are currently no mail items to display.</p>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const loading = document.getElementById("loading");
		const content = document.getElementById("content");
		const emptyState = document.getElementById("empty-state");
		const tableBody = document.getElementById("mail-items-body");
		const stats = document.getElementById("stats");

		// Function to reload data
		function loadData() {
			// –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
			loading.style.display = "block";
			content.style.display = "none";
			emptyState.style.display = "none";

			// –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
			tableBody.innerHTML = '';

			fetch("/jira/plugins/servlet/mail-items/data")
					.then(response => {
						if (!response.ok) {
							throw new Error(`HTTP error! status: ${response.status}`);
						}
						const contentType = response.headers.get("content-type");
						if (!contentType || !contentType.includes("application/json")) {
							throw new Error("Response is not JSON");
						}
						return response.json();
					})
					.then(items => {
						processMailItems(items);
					})
					.catch(error => {
						console.error('Error fetching mail items:', error);
						loading.innerHTML =
								'<div style="color: #ef4444;">' +
								'<p><strong>Error loading mail items</strong></p>' +
								'<p style="font-size: 0.9rem; margin-top: 8px;">' +
								(error.message || 'Please check your connection and try again.') +
								'</p>' +
								'</div>';
					});
		}

		// Function to create test data
		function createTestData() {
			const createBtn = document.getElementById('create-test-data-btn');
			const originalText = createBtn.textContent;

			// –û—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
			createBtn.disabled = true;
			createBtn.textContent = '‚è≥ Creating...';

			fetch("/jira/plugins/servlet/mail-items/create-test-data", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			})
					.then(response => response.json())
					.then(result => {
						if (result.success) {
							// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
							alert('Test data created successfully!');
							// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
							loadData();
						} else {
							alert('Error: ' + (result.error || 'Failed to create test data'));
						}
					})
					.catch(error => {
						console.error('Error creating test data:', error);
						alert('Failed to create test data. Please check the console for details.');
					})
					.finally(() => {
						// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
						createBtn.disabled = false;
						createBtn.textContent = originalText;
					});
		}

		// Function to delete all mail items
		function deleteAllMailItems() {
			if (!confirm('Are you sure you want to delete ALL mail items? This action cannot be undone!')) {
				return;
			}

			const deleteBtn = document.getElementById('delete-all-btn');
			const originalText = deleteBtn.textContent;

			// Disable button and show loading state
			deleteBtn.disabled = true;
			deleteBtn.textContent = '‚è≥ Deleting...';

			fetch("/jira/plugins/servlet/mail-items/delete-all", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			})
					.then(response => response.json())
					.then(result => {
						if (result.success) {
							// Show success message
							alert(result.message);

							// Clear the table and show empty state
							tableBody.innerHTML = '';
							content.style.display = "none";
							emptyState.style.display = "block";

						} else {
							alert('Error: ' + (result.error || 'Failed to delete items'));
						}
					})
					.catch(error => {
						console.error('Error deleting mail items:', error);
						alert('Failed to delete mail items. Please check the console for details.');
					})
					.finally(() => {
						// Restore button state
						deleteBtn.disabled = false;
						deleteBtn.textContent = originalText;
					});
		}

		// –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º
		const createBtn = document.getElementById('create-test-data-btn');
		if (createBtn) {
			createBtn.addEventListener('click', createTestData);
		}

		const deleteBtn = document.getElementById('delete-all-btn');
		if (deleteBtn) {
			deleteBtn.addEventListener('click', deleteAllMailItems);
		}

		// Function to create expandable content
		function createExpandableContent(text, maxLength = 100) {
			if (text.length <= maxLength) {
				return text;
			}

			const truncated = text.substring(0, maxLength) + "...";
			const fullText = text;

			const container = document.createElement('div');
			const textSpan = document.createElement('span');
			const button = document.createElement('button');

			textSpan.textContent = truncated;
			button.textContent = 'Show more';
			button.className = 'expand-btn';

			let isExpanded = false;
			button.addEventListener('click', function() {
				if (isExpanded) {
					textSpan.textContent = truncated;
					button.textContent = 'Show more';
					isExpanded = false;
				} else {
					textSpan.textContent = fullText;
					button.textContent = 'Show less';
					isExpanded = true;
				}
			});

			container.appendChild(textSpan);
			container.appendChild(document.createElement('br'));
			container.appendChild(button);

			return container;
		}

		// Function to process mail items
		function processMailItems(items) {
			loading.style.display = "none";

			if (items.length === 0) {
				emptyState.style.display = "block";
				return;
			}

			content.style.display = "block";

			items.forEach(item => {
				const row = document.createElement("tr");

				const idCell = document.createElement("td");
				idCell.className = "id-cell";
				idCell.textContent = item.id || 'Unknown';

				const fromCell = document.createElement("td");
				fromCell.className = "from-cell";
				fromCell.textContent = item.from || 'Unknown';

				const toCell = document.createElement("td");
				toCell.className = "to-cell";
				toCell.textContent = Array.isArray(item.to) ? item.to.join(", ") : (item.to || 'Unknown');

				const subjectCell = document.createElement("td");
				subjectCell.className = "subject-cell truncate";
				subjectCell.textContent = item.subject || 'No subject';
				subjectCell.title = item.subject || 'No subject';

				const bodyCell = document.createElement("td");
				bodyCell.className = "body-cell";
				const bodyContent = item.body || 'No content';
				if (bodyContent.length > 100) {
					bodyCell.appendChild(createExpandableContent(bodyContent, 100));
				} else {
					bodyCell.textContent = bodyContent;
				}
				row.appendChild(idCell);
				row.appendChild(fromCell);
				row.appendChild(toCell);
				row.appendChild(subjectCell);
				row.appendChild(bodyCell);

				tableBody.appendChild(row);
			});

			stats.textContent = 'Showing ' + items.length + ' mail item' + (items.length !== 1 ? 's' : '');
		}

		// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
		loadData();
	});
</script>
</body>
</html>
